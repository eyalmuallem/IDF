<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>×”×—×–×¨×ª ×¦×™×•×“</title>

<style>
body{
  font-family:Arial;
  direction:rtl;
  background:#f4f4f4;
  margin:0;
  padding:20px;
}
.box{
  max-width:440px;
  background:#fff;
  margin:40px auto;
  padding:22px;
  border-radius:14px;
  box-shadow:0 10px 25px rgba(0,0,0,.12);
}
h2{
  margin:0 0 14px;
  text-align:center;
}
label{
  display:block;
  margin-top:14px;
  font-weight:bold;
}
select{
  width:100%;
  padding:12px;
  font-size:16px;
  border:1px solid #ccc;
  border-radius:8px;
  margin-top:6px;
}
button{
  width:100%;
  padding:14px;
  font-size:18px;
  border:0;
  border-radius:12px;
  margin-top:18px;
  background:#16a34a;
  color:#fff;
  cursor:pointer;
}
button:disabled{
  opacity:.6;
  cursor:not-allowed;
}
.msg{
  margin-top:16px;
  min-height:24px;
  text-align:center;
  font-size:16px;
}
.ok{color:#16a34a;}
.err{color:#dc2626;}
</style>
</head>

<body>

<div class="box">
  <h2>ğŸ“¦ ×”×—×–×¨×ª ×¦×™×•×“</h2>

  <label>×‘×—×¨ ××™×¨×•×¢ ×¤×ª×•×— (OUT)</label>
  <select id="returnSelect">
    <option value="">×˜×•×¢×Ÿ ××™×¨×•×¢×™×â€¦</option>
  </select>

  <button id="btn">âœ”ï¸ ×¡××Ÿ ×›×”×•×—×–×¨</button>

  <div id="msg" class="msg"></div>
</div>

<script>
/* ===== CONFIG ===== */
const API_URL =
  "https://script.google.com/macros/s/AKfycbzWiBQ2OorLE5es5cqJ9FPN8sJC0m75r0_ky0BRBJfuQM0hPmXwDHk7m0uCRCkLFSWl/exec";

const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/1-FwT_TEBWPH-tEk1N3bi88S-9TukQ3iPJMl6l0ikDCI/gviz/tq?tqx=out:json&gid=0";

const sel = document.getElementById("returnSelect");
const btn = document.getElementById("btn");
const msg = document.getElementById("msg");

/* ===== HELPERS ===== */
function setMsg(text, cls="") {
  msg.className = "msg " + cls;
  msg.textContent = text;
}

/* ===== LOAD OPEN EVENTS (OUT) ===== */
function loadOpenEvents() {
  const currentSelection = sel.value; // ×©××™×¨×ª ×‘×—×™×¨×”

  fetch(SHEET_URL)
    .then(r => r.text())
    .then(t => {
      const json = JSON.parse(t.substring(47).slice(0, -2));
      const rows = json.table.rows || [];

      sel.innerHTML = `<option value="">×‘×—×¨ ××™×¨×•×¢â€¦</option>`;

      let foundCurrent = false;
      let count = 0;

      rows.slice(1).forEach(r => {
        const status = r.c?.[1]?.v;
        if (status !== "OUT") return;

        const doc    = r.c?.[0]?.v || "";
        const event  = r.c?.[2]?.v || "";
        const signer = r.c?.[3]?.v || "";
        const date   = r.c?.[4]?.f || r.c?.[4]?.v || "";

        const opt = document.createElement("option");
        opt.value = doc;
        opt.textContent = `${event} | ${signer} | ${date}`;

        if (doc === currentSelection) {
          opt.selected = true;
          foundCurrent = true;
        }

        sel.appendChild(opt);
        count++;
      });

      if (!count) {
        sel.innerHTML = `<option value="">××™×Ÿ ××™×¨×•×¢×™× ×¤×ª×•×—×™× ğŸ‰</option>`;
      }

      if (currentSelection && !foundCurrent) {
        setMsg("â„¹ï¸ ×”××™×¨×•×¢ ×©× ×‘×—×¨ ×›×‘×¨ ×”×•×—×–×¨", "");
      }
    })
    .catch(() => {
      sel.innerHTML = `<option value="">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×</option>`;
    });
}

/* ===== SEND RETURN ===== */
function sendReturn() {
  const doc = sel.value;
  if (!doc) {
    setMsg("× × ×œ×‘×—×•×¨ ××™×¨×•×¢", "err");
    return;
  }

  btn.disabled = true;
  setMsg("×©×•×œ×— ×¢×“×›×•×Ÿâ€¦");

  const url =
    API_URL +
    "?action=in" +
    "&doc=" + encodeURIComponent(doc) +
    "&by="  + encodeURIComponent("××—×¡×Ÿ") +
    "&_="   + Date.now();

  const img = new Image();
  img.onload = img.onerror = () => {
    setMsg("âœ”ï¸ ×¡×•××Ÿ ×›×”×•×—×–×¨", "ok");
    btn.disabled = false;
    loadOpenEvents();
  };
  img.src = url;
}

/* ===== EVENTS ===== */
btn.addEventListener("click", sendReturn);

/* ===== INIT ===== */
loadOpenEvents();

/* ===== AUTO REFRESH (×©×§×˜) ===== */
setInterval(() => {
  loadOpenEvents();
}, 12000); // ×›×œ 12 ×©× ×™×•×ª
</script>

</body>
</html>
