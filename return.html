<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>×”×—×–×¨×ª ×¦×™×•×“</title>

<style>
body{
  margin:0;
  font-family:Arial;
  direction:rtl;
  background:#f1f5f9;
  color:#111827;
}

/* Header */
.header{
  background:#0f172a;
  color:#fff;
  padding:22px 32px;
}
.header h1{
  margin:0;
  font-size:22px;
  font-weight:600;
}

/* Page */
.page{
  padding:40px 32px;
  max-width:900px;
  margin:0 auto;
}

/* Main panel */
.panel{
  background:#ffffff;
  padding:32px;
  border-radius:10px;
  box-shadow:0 4px 20px rgba(0,0,0,.06);
}

/* Form */
label{
  display:block;
  font-weight:600;
  margin-bottom:8px;
}

select{
  width:100%;
  padding:14px;
  font-size:16px;
  border:1px solid #d1d5db;
  border-radius:8px;
  margin-bottom:20px;
}

button{
  width:100%;
  padding:14px;
  font-size:16px;
  border:0;
  border-radius:8px;
  background:#2563eb;
  color:#fff;
  cursor:pointer;
}

button:disabled{
  opacity:.6;
  cursor:not-allowed;
}

/* Messages */
.msg{
  margin-top:18px;
  min-height:24px;
  font-size:15px;
}

.ok{ color:#15803d; }
.err{ color:#b91c1c; }

</style>
</head>

<body>

<header class="header">
  <h1>××¢×¨×›×ª ×”×—×–×¨×ª ×¦×™×•×“</h1>
</header>

<main class="page">
  <section class="panel">

    <label>××™×¨×•×¢×™× ×¤×ª×•×—×™×</label>
    <select id="returnSelect">
      <option value="">×˜×•×¢×Ÿ ××™×¨×•×¢×™×â€¦</option>
    </select>

    <button id="btn">×¡××Ÿ ×›×”×•×—×–×¨</button>

    <div id="msg" class="msg"></div>

  </section>
</main>

</body>


<script>
/* ===== CONFIG ===== */
const API_URL =
  "https://script.google.com/macros/s/AKfycbzWiBQ2OorLE5es5cqJ9FPN8sJC0m75r0_ky0BRBJfuQM0hPmXwDHk7m0uCRCkLFSWl/exec";

const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/1-FwT_TEBWPH-tEk1N3bi88S-9TukQ3iPJMl6l0ikDCI/gviz/tq?tqx=out:json&gid=0";

const sel = document.getElementById("returnSelect");
const btn = document.getElementById("btn");
const msg = document.getElementById("msg");

/* ===== HELPERS ===== */
function setMsg(text, cls="") {
  msg.className = "msg " + cls;
  msg.textContent = text;
}

/* ===== LOAD OPEN EVENTS (OUT) ===== */
function loadOpenEvents() {
  const currentSelection = sel.value; // ×©××™×¨×ª ×‘×—×™×¨×”

  fetch(SHEET_URL)
    .then(r => r.text())
    .then(t => {
      const json = JSON.parse(t.substring(47).slice(0, -2));
      const rows = json.table.rows || [];

      sel.innerHTML = `<option value="">×‘×—×¨ ××™×¨×•×¢â€¦</option>`;

      let foundCurrent = false;
      let count = 0;

      rows.slice(1).forEach(r => {
        const status = r.c?.[1]?.v;
        if (status !== "OUT") return;

        const doc    = r.c?.[0]?.v || "";
        const event  = r.c?.[2]?.v || "";
        const signer = r.c?.[3]?.v || "";
        const date   = r.c?.[4]?.f || r.c?.[4]?.v || "";

        const opt = document.createElement("option");
        opt.value = doc;
        opt.textContent = `${event} | ${signer} | ${date}`;

        if (doc === currentSelection) {
          opt.selected = true;
          foundCurrent = true;
        }

        sel.appendChild(opt);
        count++;
      });

      if (!count) {
        sel.innerHTML = `<option value="">××™×Ÿ ××™×¨×•×¢×™× ×¤×ª×•×—×™× ğŸ‰</option>`;
      }

      if (currentSelection && !foundCurrent) {
        setMsg("â„¹ï¸ ×”××™×¨×•×¢ ×©× ×‘×—×¨ ×›×‘×¨ ×”×•×—×–×¨", "");
      }
    })
    .catch(() => {
      sel.innerHTML = `<option value="">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×</option>`;
    });
}

/* ===== SEND RETURN ===== */
function sendReturn() {
  const doc = sel.value;
  if (!doc) {
    setMsg("× × ×œ×‘×—×•×¨ ××™×¨×•×¢", "err");
    return;
  }

  btn.disabled = true;
  setMsg("×©×•×œ×— ×¢×“×›×•×Ÿâ€¦");

  const url =
    API_URL +
    "?action=in" +
    "&doc=" + encodeURIComponent(doc) +
    "&by="  + encodeURIComponent("××—×¡×Ÿ") +
    "&_="   + Date.now();

  const img = new Image();
  img.onload = img.onerror = () => {
    setMsg("âœ”ï¸ ×¡×•××Ÿ ×›×”×•×—×–×¨", "ok");
    btn.disabled = false;
    loadOpenEvents();
  };
  img.src = url;
}

/* ===== EVENTS ===== */
btn.addEventListener("click", sendReturn);

/* ===== INIT ===== */
loadOpenEvents();

/* ===== AUTO REFRESH (×©×§×˜) ===== */
setInterval(() => {
  loadOpenEvents();
}, 12000); // ×›×œ 12 ×©× ×™×•×ª
</script>

</body>
</html>
